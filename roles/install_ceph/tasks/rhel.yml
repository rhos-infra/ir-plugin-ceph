- name: setup rhceph-3.0.repo
  template: src=./templates/rhceph-3.0.repo.j2 dest=/etc/yum.repos.d/rhceph-3.0.repo

- name: check for subscription
  command: subscription-manager identity
  become: yes
  ignore_errors: yes
  register: cdn_status

- name: Register as user (subscr_user) with password (subscr_passwd) and auto-subscribe to available content if needed
  redhat_subscription:
     server_hostname: "{{subscr_server}}" 
     state: present
     username: "{{ subscr_user}}"
     password: "{{ subscr_password }}"
     autosubscribe: true
     server_insecure: yes
  when: cdn_status|failed
  retries: 10
  delay: 1
  ignore_errors: yes
  
- name: Install ceph-ansible
  yum: name=ceph-ansible state=present


- name: ignore the SSH authenticity checking made by Ansible
  lineinfile: dest=/usr/share/ceph-ansible/ansible.cfg line="host_key_checking = False"  insertafter=EOF state=present

- name: Copy all.yml.sample to all.yml
  copy: remote_src=True src=/usr/share/ceph-ansible/group_vars/all.yml.sample dest=/usr/share/ceph-ansible/group_vars/all.yml
- name: Configure package origin
  lineinfile: dest=/usr/share/ceph-ansible/group_vars/all.yml line="ceph_origin{{":"}} 'upstream'" insertafter=EOF state=present
- name: Configure all.yml
  blockinfile:
    path: /usr/share/ceph-ansible/group_vars/all.yml
    block: |
      ceph_stable: true
      cephx: true
      monitor_address: "{{ansible_default_ipv4.address}}"
      journal_size: 128
      public_network: "{{ ansible_default_ipv4.address}}/{{ ansible_default_ipv4.netmask | ipaddr('prefix') }}"
      ceph_conf_overrides:
          global:
            osd max object name len: 256
            osd max object namespace len: 64
            osd pool default size: 1
            osd pool default min size: 1
            osd pool default pg num: 128
      mon_group_name: mons
      osd_group_name: osds
      rgw_group_name: rgws
      mds_group_name: mdss
      restapi_group_name: restapis
      client_group_name: clients
      radosgw_civetweb_port: 8080
      docker: true 
      ceph_docker_image: "ceph/daemon"
      ceph_docker_image_tag: latest
      containerized_deployment_with_kv: true 
      containerized_deployment: true 
      mon_containerized_default_ceph_conf_with_kv: true 
      generate_fsid: true
      ceph_docker_registry: docker.io
      mon_use_fqdn: false # if set to true, the MON name used will be the fqdn
      kv_type: etcd
      kv_endpoint: 127.0.0.1
      kv_port: 4001
      containerized_deployment_with_kv: true 
  when: install.containers.enabled == True

- name: Copy mons.yml.sample to mons.yml
  copy: remote_src=True src=/usr/share/ceph-ansible/group_vars/mons.yml.sample dest=/usr/share/ceph-ansible/group_vars/mons.yml
  when: install.containers.enabled == True
    
- name: Configure mons.yml additions for docker
  blockinfile:
    path: /usr/share/ceph-ansible/group_vars/mons.yml
    block: |
      mon_group_name: mons
  when: install.containers.enabled == True

#
#- name: copy prepare_osd.sh
#  template: src=./templates/prepare_osd.sh.j2 dest=/tmp/prepare_osd.sh

#- name: perpare osd (todo use built in ansible module)
#  shell: chmod +x /tmp/prepare_osd.sh; /tmp/prepare_osd.sh

# (TODO: figure out N from /dev/loopN and update osds.yml)

- name: Copy osds.yml.sample to osds.yml
  copy: remote_src=True src=/usr/share/ceph-ansible/group_vars/osds.yml.sample dest=/usr/share/ceph-ansible/group_vars/osds.yml

- name: Configure osds.yml
  blockinfile:
    path: /usr/share/ceph-ansible/group_vars/osds.yml
    block: |
      crush_location: true
      osd_crush_location: "'root=ceph_crush_root rack=ceph_crush_rack host={{ ansible_hostname }}'"
      devices:
        - /dev/vdb1
        - /dev/vdb2 
      journal_collocation: true
      ceph_osd_docker_devices: {{ '"{{' }} devices {{ '}}"' }}
      ceph_osd_docker_prepare_env: -e CLUSTER={{ '{{' }} cluster {{ '}}' }} -e OSD_JOURNAL_SIZE={{ '{{' }} journal_size {{ '}}' }} -e OSD_FORCE_ZAP=1"
  when: install.containers.enabled == True


- name: Copy site.yml.sample to site.yml
  copy: remote_src=True src=/usr/share/ceph-ansible/site.yml.sample dest=/usr/share/ceph-ansible/site.yml
  when: install.containers.enabled == False
  
- name: Copy site-docker.yml.sample to site.yml
  copy: remote_src=True src=/usr/share/ceph-ansible/site-docker.yml.sample dest=/usr/share/ceph-ansible/site.yml
  when: install.containers.enabled == True

- name: Create and configure hosts file
  blockinfile:
    path: /usr/share/ceph-ansible/hosts
    create: yes
    block: |
      [clients]
      localhost ansible_connection=local
      
      [mons]
      localhost ansible_connection=local
      
      [osds]
      localhost ansible_connection=local
      
      [mdss]
      localhost ansible_connection=local
      
      [restapis]
      localhost ansible_connection=local

- name: install python-netaddr required to resolve ansible_default_ipv4.address
  yum: name=python-netaddr state=present

- name: Install ceph
  shell: ansible-playbook -vv -i hosts site.yml
  args:
     chdir: /usr/share/ceph-ansible

- name: Workaround. Fix ceph cluster health by reducing the number of replicas in each pool
  shell: "{{ item }}"
  with_items:
    - "ceph osd pool set cephfs_data size 1"
    - "ceph osd pool set cephfs_metadata size 1"

- name: Ceph health
  shell: ceph -s
  register: command_result
  failed_when: "'HEALTH_OK' not in command_result.stdout"

